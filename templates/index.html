<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>skillbridge.AI ‚Äì Your AI-Powered Career Companion</title>
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #13182e;
            --bg-tertiary: #1a1f3a;
            --bg-card: rgba(26, 31, 58, 0.6);
            --accent-primary: #5b8cff;
            --accent-secondary: #7c4dff;
            --accent-success: #18c79c;
            --accent-warning: #ffb020;
            --accent-error: #ff6b6b;
            --text-primary: #e7ecff;
            --text-secondary: #a6b0cf;
            --text-muted: #6b7280;
            --border-color: rgba(91, 140, 255, 0.15);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background: radial-gradient(ellipse at top left, rgba(91, 140, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(ellipse at bottom right, rgba(124, 77, 255, 0.1) 0%, transparent 50%),
                        var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            padding: 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Navbar */
        .navbar {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-md);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 12px rgba(91, 140, 255, 0.3);
        }

        .brand-text {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, rgba(91, 140, 255, 0.08) 0%, rgba(124, 77, 255, 0.08) 100%);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 64px 48px;
            margin-bottom: 32px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(91, 140, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
        }

        .hero-title {
            font-size: 48px;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .hero-description {
            font-size: 18px;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 48px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-top: 48px;
        }

        .hero-feature {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 32px 24px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .hero-feature:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .hero-feature-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .hero-feature-icon svg {
            width: 28px;
            height: 28px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* Skill Analysis - Blue/Purple gradient */
        .hero-feature:nth-child(1) .hero-feature-icon {
            background: linear-gradient(135deg, #5b8cff 0%, #7c4dff 100%);
        }

        /* Course Recommendations - Teal/Green gradient */
        .hero-feature:nth-child(2) .hero-feature-icon {
            background: linear-gradient(135deg, #18c79c 0%, #10b981 100%);
        }

        /* Project Ideas - Orange/Red gradient */
        .hero-feature:nth-child(3) .hero-feature-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        }

        /* Gap Analysis - Pink/Purple gradient */
        .hero-feature:nth-child(4) .hero-feature-icon {
            background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%);
        }

        .hero-feature:hover .hero-feature-icon {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .hero-feature-icon svg path {
            fill: white;
            opacity: 1;
        }

        .hero-feature-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(91, 140, 255, 0.05);
            color: var(--accent-primary);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(91, 140, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card Component */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-body {
            padding: 24px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type="file"] {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: var(--accent-primary);
            background: rgba(91, 140, 255, 0.05);
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(91, 140, 255, 0.1);
        }

        button[type="submit"] {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(91, 140, 255, 0.3);
        }

        button[type="submit"]:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(91, 140, 255, 0.4);
        }

        button[type="submit"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Section */
        .result-area {
            margin-top: 0;
        }
        
        /* Reduce top padding for result area in cards */
        .card-body .result-area {
            padding-top: 0;
            margin-top: 0;
        }

        .result-area pre {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Alert Styles */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            border: 1px solid;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .alert-success {
            background: rgba(24, 199, 156, 0.1);
            border-color: rgba(24, 199, 156, 0.3);
            color: var(--accent-success);
        }

        .alert-error {
            background: rgba(255, 107, 107, 0.1);
            border-color: rgba(255, 107, 107, 0.3);
            color: var(--accent-error);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.15);
            border: 2px solid rgba(251, 191, 36, 0.4);
            color: #fbbf24;
            padding: 20px 24px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.1);
        }

        .alert-warning-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .alert-warning-content {
            flex: 1;
            line-height: 1.6;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Skills Section */
        .skills-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .skills-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 12px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .skills-header:hover {
            background: rgba(91, 140, 255, 0.05);
        }

        .skills-header-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .skills-header-stats {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .section-content {
            display: block;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .section-content.collapsed {
            display: none;
        }

        .skills-header {
            cursor: pointer;
            user-select: none;
        }

        .skills-header .arrow-icon {
            transition: transform 0.2s ease;
            display: inline-block;
            font-size: 14px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 0 12px 0;
        }

        .skill-tag {
            display: inline-block;
            padding: 8px 14px;
            margin: 6px 6px 6px 0;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
        }

        .skill-matched {
            background: rgba(24, 199, 156, 0.15);
            border: 1px solid rgba(24, 199, 156, 0.3);
            color: var(--accent-success);
        }

        .skill-missing {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
        }

        /* Course & Project Cards */
        .content-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
        }

        .content-card h3, .content-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .course-card, .project-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 20px;
        }

        .course-card h4, .project-card h4 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .course-detail, .project-detail {
            margin: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .course-detail strong, .project-detail strong {
            color: var(--text-primary);
            font-weight: 600;
            display: inline-block;
            min-width: 140px;
        }

        .course-description, .project-description {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            line-height: 1.8;
            color: var(--text-secondary);
        }

        .content-card ul, .course-card ul, .project-card ul {
            margin: 8px 0;
            padding-left: 24px;
        }

        .content-card ul li, .course-card ul li, .project-card ul li {
            margin: 6px 0;
            color: var(--text-secondary);
        }

        /* Project Badge */
        .project-badge {
            display: inline-block;
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .badge-current {
            background: #34D399;
            color: white;
            box-shadow: 0 4px 12px rgba(52, 211, 153, 0.3);
        }

        .badge-missing {
            background: #8B5CF6;
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .project-card-item {
            border-left: 4px solid;
            padding-left: 20px;
        }

        .project-card-item.current {
            border-left-color: #34D399;
        }

        .project-card-item.missing {
            border-left-color: #8B5CF6;
        }

        /* Toggle Button */
        .toggle-section, .toggle-json {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .toggle-section:hover, .toggle-json:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(91, 140, 255, 0.3);
        }

        /* Cover Letter View */
        .cover-letter-view {
            background: var(--bg-tertiary);
            padding: 24px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            line-height: 1.8;
            color: var(--text-primary);
            margin-top: 16px;
        }

        .cover-letter-view p {
            margin-bottom: 15px;
        }

        .cover-letter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cover-letter-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .copy-button {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .copy-button:hover {
            background: rgba(91, 140, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .copy-button:active {
            transform: scale(0.98);
        }

        .copy-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(24, 199, 156, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .copy-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="brand">
                <div class="brand-logo">SB</div>
                <div class="brand-text">skillbridge.AI</div>
            </div>
            <div class="nav-actions">
                <span class="badge">v1.0.0</span>
                <span class="badge">AI-Powered</span>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h1 class="hero-title">AI-Powered Career Bridge</h1>
                <p class="hero-description">
                    Your AI-powered career companion for students and job seekers. Upload your r√©sum√©, analyze it against any job description, 
                    and instantly discover what skills you're missing. Get personalized course recommendations, hands-on project ideas, 
                    and AI-generated cover letters to land your internship/new grad job.
                </p>
                <div class="hero-features">
                    <div class="hero-feature">
                        <div class="hero-feature-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 3V21H21V3H3ZM5 5H19V19H5V5ZM7 7V17H17V7H7ZM9 9H15V11H9V9ZM9 13H15V15H9V13Z" fill="white"/>
                            </svg>
                        </div>
                        <h3 class="hero-feature-title">Resume Analysis</h3>
                    </div>
                    <div class="hero-feature">
                        <div class="hero-feature-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19ZM17 12H7V10H17V12ZM15 16H7V14H15V16ZM17 8H7V6H17V8Z" fill="white"/>
                            </svg>
                        </div>
                        <h3 class="hero-feature-title">Learn Skills</h3>
                    </div>
                    <div class="hero-feature">
                        <div class="hero-feature-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2.81 14.12L5.64 11.29L8.17 10.79C11.39 6.41 17.55 4.22 19.78 4.22C19.78 6.45 17.59 12.61 13.21 15.83L12.71 18.36L9.88 21.19C9.34 21.74 8.71 22 8.08 22C7.45 22 6.83 21.74 6.29 21.19L2.81 17.71C1.71 16.61 1.71 14.83 2.81 14.12ZM8.08 20.29L11 17.36L11.64 14.64L14.36 14L17.29 11.08C16.74 11.26 16.05 11.55 15.33 11.94C14.28 12.49 13.11 13.25 12.06 14.06C11.25 15.11 10.49 16.28 9.94 17.33C9.55 18.05 9.26 18.74 9.08 19.29L8.08 20.29Z" fill="white"/>
                            </svg>
                        </div>
                        <h3 class="hero-feature-title">Build Projects</h3>
                    </div>
                    <div class="hero-feature">
                        <div class="hero-feature-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 7H13V11H17V13H13V17H11V13H7V11H11V7Z" fill="white"/>
                            </svg>
                        </div>
                        <h3 class="hero-feature-title">Create Cover Letters</h3>
                    </div>
                </div>
            </div>
        </section>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('analyze', event)">Skill Gap Analyzer</button>
            <button class="tab-button" onclick="showTab('cover', event)">Cover Letter Generator</button>
        </div>
        
        <div id="analyze" class="tab-content active">
            {% include 'skill_analyzer.html' %}
        </div>
        
        <div id="cover" class="tab-content">
            {% include 'cover_letter.html' %}
        </div>
    </div>
    
    <script>
        function showTab(tabId, event) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked button
            if (event) {
                event.target.classList.add('active');
            } else {
                // Fallback: find button by tab ID
                document.querySelectorAll('.tab-button').forEach(button => {
                    if (button.textContent.includes(tabId === 'analyze' ? 'Skill Gap' : 'Cover Letter')) {
                        button.classList.add('active');
                    }
                });
            }
        }
        
        // Function to render skill analyzer results
        function renderSkillAnalyzerResults(data) {
            let html = '';
            
            // Success message
            html += '<div class="alert alert-success">‚úÖ Analysis complete! Your comprehensive report is ready.</div>';
            
            // Grad student warning
            if (data.is_grad_student_job) {
                html += '<div class="alert alert-warning">';
                html += '<div class="alert-warning-icon">üéì</div>';
                html += '<div class="alert-warning-content">';
                html += '<strong>Graduate Student Position Detected</strong><br>';
                html += 'This job requires a Master\'s or PhD degree. You may not be qualified for this position based on education requirements. However, you may still take your shot if you want to apply.';
                html += '</div></div>';
            }
            
            // Metrics grid
            html += '<div class="metrics-grid">';
            html += '<div class="metric-card">';
            html += '<div class="metric-label">Overall Match</div>';
            html += '<div class="metric-value">' + data.overall_score.weighted_score.toFixed(1) + '%</div>';
            html += '</div>';
            html += '<div class="metric-card">';
            html += '<div class="metric-label">Required Coverage</div>';
            html += '<div class="metric-value">' + data.required_skills.match_score.toFixed(1) + '%</div>';
            html += '</div>';
            html += '<div class="metric-card">';
            html += '<div class="metric-label">Preferred Coverage</div>';
            html += '<div class="metric-value">' + data.preferred_skills.match_score.toFixed(1) + '%</div>';
            html += '</div>';
            html += '</div>';
            
            // Required Skills
            html += '<div class="skills-section">';
            html += '<div class="skills-header collapsed" id="required-skills-header" onclick="toggleSkillsSection(\'required-skills\')">';
            html += '<div>';
            html += '<div class="skills-header-title">üìã Required Skills Coverage</div>';
            html += '<div class="skills-header-stats">' + data.required_skills.covered_count + ' of ' + data.required_skills.total_count + ' skills matched</div>';
            html += '</div>';
            html += '<div class="arrow-icon" style="color: var(--accent-primary);">‚ñ∫</div>';
            html += '</div>';
            html += '<div id="required-skills" class="section-content collapsed">';
            if (data.required_skills.covered_skills && data.required_skills.covered_skills.length > 0) {
                html += '<div class="section-title">‚úÖ Matched Skills (' + data.required_skills.covered_skills.length + ')</div>';
                data.required_skills.covered_skills.forEach(skill => {
                    html += '<span class="skill-tag skill-matched">' + escapeHtml(skill) + '</span>';
                });
            } else {
                html += '<div class="section-title">No matched skills</div>';
            }
            if (data.required_skills.missing_skills && data.required_skills.missing_skills.length > 0) {
                html += '<div class="section-title" style="margin-top: 20px;">‚ùå Missing Skills (' + data.required_skills.missing_skills.length + ')</div>';
                data.required_skills.missing_skills.forEach(skill => {
                    html += '<span class="skill-tag skill-missing">' + escapeHtml(skill) + '</span>';
                });
            } else {
                html += '<div class="section-title" style="margin-top: 20px;">‚úÖ All required skills covered!</div>';
            }
            html += '</div>';
            html += '</div>';
            
            // Preferred Skills
            html += '<div class="skills-section">';
            html += '<div class="skills-header collapsed" id="preferred-skills-header" onclick="toggleSkillsSection(\'preferred-skills\')">';
            html += '<div>';
            html += '<div class="skills-header-title">‚≠ê Preferred Skills Coverage</div>';
            html += '<div class="skills-header-stats">' + data.preferred_skills.covered_count + ' of ' + data.preferred_skills.total_count + ' skills matched</div>';
            html += '</div>';
            html += '<div class="arrow-icon" style="color: var(--accent-primary);">‚ñ∫</div>';
            html += '</div>';
            html += '<div id="preferred-skills" class="section-content collapsed">';
            if (data.preferred_skills.covered_skills && data.preferred_skills.covered_skills.length > 0) {
                html += '<div class="section-title">‚úÖ Matched Skills (' + data.preferred_skills.covered_skills.length + ')</div>';
                data.preferred_skills.covered_skills.forEach(skill => {
                    html += '<span class="skill-tag skill-matched">' + escapeHtml(skill) + '</span>';
                });
            } else {
                html += '<div class="section-title">No matched skills</div>';
            }
            if (data.preferred_skills.missing_skills && data.preferred_skills.missing_skills.length > 0) {
                html += '<div class="section-title" style="margin-top: 20px;">‚ùå Missing Skills (' + data.preferred_skills.missing_skills.length + ')</div>';
                data.preferred_skills.missing_skills.forEach(skill => {
                    html += '<span class="skill-tag skill-missing">' + escapeHtml(skill) + '</span>';
                });
            } else {
                html += '<div class="section-title" style="margin-top: 20px;">‚úÖ All preferred skills covered!</div>';
            }
            html += '</div>';
            html += '</div>';
            
            // Course Recommendations
            if (data.course_recommendations) {
                html += '<div class="content-card">';
                html += '<h4>üìö Course Recommendations</h4>';
                
                // Combine free and paid courses, label them appropriately
                const allCourses = [];
                
                // Add first free course with "Free Course" label (green badge)
                if (data.course_recommendations.free_courses && data.course_recommendations.free_courses.length > 0) {
                    allCourses.push({
                        ...data.course_recommendations.free_courses[0],
                        label: 'Free Course',
                        badgeClass: 'badge-current'
                    });
                }
                
                // Add first paid course with "Paid Course" label (purple badge)
                if (data.course_recommendations.paid_courses && data.course_recommendations.paid_courses.length > 0) {
                    allCourses.push({
                        ...data.course_recommendations.paid_courses[0],
                        label: 'Paid Course',
                        badgeClass: 'badge-missing'
                    });
                }
                
                // Render courses in project-style cards
                allCourses.forEach((course, idx) => {
                    html += '<div style="margin-bottom: 24px;">';
                    html += '<span class="project-badge ' + course.badgeClass + '">+ ' + course.label.toUpperCase() + '</span>';
                    // Add border color class based on course type
                    const borderClass = course.label === 'Free Course' ? 'current' : 'missing';
                    html += '<div class="course-card project-card-item ' + borderClass + '">';
                    html += '<h4>' + escapeHtml(course.title || 'Untitled Course') + '</h4>';
                    html += '<div class="project-detail"><strong>Platform:</strong> ' + escapeHtml(course.platform || 'N/A') + '</div>';
                    html += '<div class="project-detail"><strong>Duration:</strong> ' + escapeHtml(course.duration || 'N/A') + '</div>';
                    html += '<div class="project-detail"><strong>Difficulty:</strong> ' + escapeHtml(course.difficulty || 'N/A') + '</div>';
                    html += '<div class="project-detail"><strong>Cost:</strong> ' + escapeHtml(course.cost || (course.label === 'Free Course' ? 'Free' : 'N/A')) + '</div>';
                    
                    if (course.description) {
                        html += '<div class="project-description"><strong>Description:</strong><br>' + escapeHtml(course.description) + '</div>';
                    }
                    
                    if (course.skills_covered && course.skills_covered.length > 0) {
                        html += '<div class="project-detail"><strong>Skills Covered:</strong> ';
                        course.skills_covered.forEach((skill, skillIdx) => {
                            html += '<span class="skill-tag skill-matched">' + escapeHtml(skill) + '</span>';
                        });
                        html += '</div>';
                    }
                    
                    if (course.additional_skills && course.additional_skills.length > 0) {
                        html += '<div class="project-detail"><strong>Additional Skills:</strong> ' + course.additional_skills.map(s => escapeHtml(s)).join(', ') + '</div>';
                    }
                    
                    if (course.link) {
                        html += '<div class="project-detail"><strong>Link:</strong> <a href="' + escapeHtml(course.link) + '" target="_blank" style="color: var(--accent-primary); text-decoration: none;">' + escapeHtml(course.link) + '</a></div>';
                    }
                    
                    if (course.why_efficient) {
                        html += '<div class="project-detail"><strong>Why This Course:</strong> ' + escapeHtml(course.why_efficient) + '</div>';
                    }
                    
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            // Project Recommendations
            if (data.project_recommendations && Object.keys(data.project_recommendations).length > 0) {
                html += '<div class="content-card">';
                html += '<h4>üöÄ Project Recommendations</h4>';
                
                Object.entries(data.project_recommendations).forEach(([track, projects]) => {
                    html += '<div style="margin-bottom: 20px;">';
                    html += '<h4 style="color: var(--accent-primary); font-weight: 600; margin-bottom: 15px;">Track: ' + escapeHtml(track) + '</h4>';
                    
                    projects.forEach((project, idx) => {
                        const isCurrentSkills = idx === 0;
                        const badgeText = isCurrentSkills ? '‚ú® Build with Your Current Skills' : 'üéØ Learn Missing Skills & Fill the Gap';
                        const badgeClass = isCurrentSkills ? 'badge-current' : 'badge-missing';
                        const cardClass = isCurrentSkills ? 'current' : 'missing';
                        
                        // Generate unique ID for this project's outline
                        const projectId = 'project-' + track.replace(/[^a-zA-Z0-9]/g, '-') + '-' + idx;
                        
                        html += '<div style="margin-bottom: 24px;">';
                        html += '<span class="project-badge ' + badgeClass + '">' + badgeText + '</span>';
                        html += '<div class="course-card project-card-item ' + cardClass + '">';
                        html += '<h4>' + escapeHtml(project.title || 'Untitled Project') + '</h4>';
                        html += '<div class="project-detail"><strong>Difficulty:</strong> ' + escapeHtml(project.difficulty || 'N/A') + '</div>';
                        html += '<div class="project-detail"><strong>Estimated Time:</strong> ' + escapeHtml(project.estimated_time || 'N/A') + '</div>';
                        
                        if (project.description) {
                            html += '<div class="project-description"><strong>Description:</strong><br>' + escapeHtml(project.description) + '</div>';
                        }
                        
                        if (project.tech_stack && project.tech_stack.length > 0) {
                            html += '<div class="project-detail"><strong>Tech Stack:</strong><ul>';
                            project.tech_stack.forEach(tech => {
                                html += '<li>' + escapeHtml(tech) + '</li>';
                            });
                            html += '</ul></div>';
                        }
                        
                        if (project.key_features && project.key_features.length > 0) {
                            html += '<div class="project-detail"><strong>Key Features:</strong><ul>';
                            project.key_features.forEach(feature => {
                                html += '<li>' + escapeHtml(feature) + '</li>';
                            });
                            html += '</ul></div>';
                        }
                        
                        if (project.skills_demonstrated && project.skills_demonstrated.length > 0) {
                            html += '<div class="project-detail"><strong>Skills Demonstrated:</strong> ' + project.skills_demonstrated.map(s => escapeHtml(s)).join(', ') + '</div>';
                        }
                        
                        if (project.technologies && project.technologies.length > 0) {
                            html += '<div class="project-detail"><strong>Technologies:</strong> ' + project.technologies.map(t => escapeHtml(t)).join(', ') + '</div>';
                        }
                        
                        if (project.project_outline) {
                            html += '<div class="project-detail">';
                            html += '<strong>Project Outline:</strong> ';
                            html += '<span id="' + projectId + '-outline" style="cursor: pointer; color: var(--accent-primary); text-decoration: none; display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor=\'var(--bg-secondary)\'" onmouseout="this.style.backgroundColor=\'transparent\'" onclick="toggleProjectPhases(\'' + projectId + '\')">';
                            html += '<span id="' + projectId + '-arrow" style="display: inline-block; transition: transform 0.3s; font-size: 0.9em;">‚ñ∂</span>';
                            html += '<span>' + escapeHtml(project.project_outline) + '</span>';
                            html += '</span>';
                            html += '<div id="' + projectId + '-phases" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid var(--accent-primary);">';
                            html += '<strong style="display: block; margin-bottom: 8px;">Implementation Phases:</strong>';
                            if (project.implementation_phases && project.implementation_phases.length > 0) {
                                project.implementation_phases.forEach((phase, phaseIdx) => {
                                    const phaseName = typeof phase === 'object' ? phase.phase : phase;
                                    const phaseDetails = typeof phase === 'object' ? phase.details : '';
                                    html += '<div style="margin-bottom: 12px;">';
                                    html += '<strong style="color: var(--accent-primary);">' + escapeHtml(phaseName || 'Phase ' + (phaseIdx + 1)) + '</strong>';
                                    if (phaseDetails) {
                                        html += '<div style="margin-top: 4px; margin-left: 16px; color: var(--text-secondary);">' + escapeHtml(phaseDetails) + '</div>';
                                    }
                                    html += '</div>';
                                });
                            } else {
                                html += '<div style="color: var(--text-secondary);">No implementation phases available.</div>';
                            }
                            html += '</div>';
                            html += '</div>';
                        }
                        
                        if (project.portfolio_impact) {
                            html += '<div class="project-detail"><strong>Portfolio Impact:</strong> ' + escapeHtml(project.portfolio_impact) + '</div>';
                        }
                        
                        if (project.bonus_challenges && project.bonus_challenges.length > 0) {
                            html += '<div class="project-detail"><strong>Bonus Challenges:</strong><ul>';
                            project.bonus_challenges.forEach(challenge => {
                                html += '<li>' + escapeHtml(challenge) + '</li>';
                            });
                            html += '</ul></div>';
                        }
                        
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    });
                    
                    html += '</div>';
                });
                
                html += '</div>';
            }
            
            // Add download button
            html += '<button class="toggle-section" onclick="downloadAnalysisReport()" style="margin-top: 24px;">üì• Download Full Report</button>';
            
            return html;
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        function toggleProjectPhases(projectId) {
            const phasesDiv = document.getElementById(projectId + '-phases');
            const outlineSpan = document.getElementById(projectId + '-outline');
            const arrowSpan = document.getElementById(projectId + '-arrow');
            if (phasesDiv) {
                if (phasesDiv.style.display === 'none') {
                    phasesDiv.style.display = 'block';
                    if (arrowSpan) {
                        arrowSpan.style.transform = 'rotate(90deg)';
                        arrowSpan.textContent = '‚ñº';
                    }
                    if (outlineSpan) {
                        outlineSpan.style.fontWeight = '600';
                    }
                } else {
                    phasesDiv.style.display = 'none';
                    if (arrowSpan) {
                        arrowSpan.style.transform = 'rotate(0deg)';
                        arrowSpan.textContent = '‚ñ∂';
                    }
                    if (outlineSpan) {
                        outlineSpan.style.fontWeight = 'normal';
                    }
                }
            }
        }
        
        function toggleSkillsSection(id) {
            const section = document.getElementById(id);
            const header = document.getElementById(id + '-header');
            if (section) {
                const isCollapsed = section.classList.contains('collapsed');
                section.classList.toggle('collapsed');
                if (header) {
                    header.classList.toggle('collapsed');
                    // Update arrow icon
                    const arrowIcon = header.querySelector('.arrow-icon');
                    if (arrowIcon) {
                        arrowIcon.textContent = isCollapsed ? '‚ñº' : '‚ñ∫';
                    }
                }
            }
        }
        
        function downloadAnalysisReport() {
            // Get the result area content
            const resultArea = document.getElementById('analyzeResult');
            if (!resultArea) {
                alert('No analysis results to download.');
                return;
            }
            
            // Clone the result content
            const content = resultArea.cloneNode(true);
            
            // Remove the download button from the clone
            const downloadBtn = content.querySelector('button');
            if (downloadBtn) {
                downloadBtn.remove();
            }
            
            // Expand all collapsed sections in the clone
            const collapsedSections = content.querySelectorAll('.section-content.collapsed');
            collapsedSections.forEach(section => {
                section.classList.remove('collapsed');
            });
            
            // Update arrow icons to show expanded state
            const headers = content.querySelectorAll('.skills-header');
            headers.forEach(header => {
                header.classList.remove('collapsed');
                const arrowIcon = header.querySelector('.arrow-icon');
                if (arrowIcon) {
                    arrowIcon.textContent = '‚ñº';
                }
            });
            
            // Create a comprehensive HTML document
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skill Gap Analysis Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background: #0a0e27;
            color: #e7ecff;
            padding: 40px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #5b8cff 0%, #7c4dff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .report-date {
            color: #a6b0cf;
            margin-bottom: 30px;
        }
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid;
        }
        .alert-success {
            background: rgba(24, 199, 156, 0.15);
            border-color: rgba(24, 199, 156, 0.3);
            color: #18c79c;
        }
        .alert-warning {
            background: rgba(255, 176, 32, 0.15);
            border-color: rgba(255, 176, 32, 0.3);
            color: #ffb020;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .metric-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(91, 140, 255, 0.15);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }
        .metric-label {
            font-size: 14px;
            color: #a6b0cf;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #5b8cff;
        }
        .content-card {
            background: rgba(26, 31, 58, 0.6);
            border: 1px solid rgba(91, 140, 255, 0.15);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .content-card h4 {
            font-size: 20px;
            font-weight: 700;
            color: #e7ecff;
            margin-bottom: 20px;
        }
        .skill-tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin: 4px;
        }
        .skill-matched {
            background: rgba(24, 199, 156, 0.15);
            border: 1px solid rgba(24, 199, 156, 0.3);
            color: #18c79c;
        }
        .skill-missing {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.4);
            color: #ff6b6b;
        }
        .project-badge {
            display: inline-block;
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: white;
        }
        .badge-current {
            background: #34D399;
        }
        .badge-missing {
            background: #8B5CF6;
        }
        .course-card, .project-card {
            background: #13182e;
            border: 1px solid rgba(91, 140, 255, 0.15);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .project-card-item.current {
            border-left-color: #34D399;
        }
        .project-card-item.missing {
            border-left-color: #8B5CF6;
        }
        .project-detail, .course-detail {
            margin: 12px 0;
            font-size: 14px;
            color: #a6b0cf;
        }
        .project-description {
            margin: 16px 0;
            color: #a6b0cf;
            line-height: 1.6;
        }
        ul {
            margin: 8px 0;
            padding-left: 24px;
        }
        li {
            margin: 6px 0;
            color: #a6b0cf;
        }
        .skills-section {
            margin-bottom: 24px;
        }
        .skills-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(26, 31, 58, 0.4);
            border: 1px solid rgba(91, 140, 255, 0.15);
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        .section-content {
            display: block;
            margin-top: 16px;
            padding-top: 16px;
        }
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #a6b0cf;
            margin-bottom: 12px;
            margin-top: 16px;
        }
        @media print {
            body {
                background: white;
                color: black;
            }
            .content-card, .metric-card, .course-card, .project-card {
                background: #f5f5f5;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Skill Gap Analysis Report</h1>
        <div class="report-date">Generated: ${new Date().toLocaleString()}</div>
        ${content.innerHTML}
    </div>
</body>
</html>`;
            
            // Create blob and download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `skill-gap-analysis-report-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Skill Analyzer form handler with automatic fallback to sync endpoint
        document.getElementById('analyzeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const resumeFile = document.getElementById('analyzeResume').files[0];
            const jobText = document.getElementById('analyzeJobText').value;
            
            if (!resumeFile || !jobText) {
                alert('Please upload a resume and provide a job description.');
                return;
            }
            
            formData.append('resume', resumeFile);
            formData.append('job_text', jobText);
            
            const submitBtn = document.querySelector('#analyzeForm button[type="submit"]');
            const resultArea = document.getElementById('analyzeResult');
            
            submitBtn.disabled = true;
            
            // Initialize simple progress display - single line with spinner (minimal spacing)
            resultArea.innerHTML = '<div style="padding: 0; display: flex; align-items: center; gap: 12px;"><div class="spinner" style="border: 2px solid var(--border-color); border-top: 2px solid var(--accent-primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;"></div><span id="progressText" style="color: var(--text-secondary); font-size: 14px;">Processing...</span></div>';
            const progressText = document.getElementById('progressText');
            
            // Helper function to try sync endpoint as fallback
            const trySyncEndpoint = async () => {
                if (progressText) {
                    progressText.textContent = 'Processing (using fallback method)...';
                }
                // Recreate FormData since it can only be read once
                const syncFormData = new FormData();
                syncFormData.append('resume', resumeFile);
                syncFormData.append('job_text', jobText);
                
                const syncResponse = await fetch('/analyze-sync', {
                    method: 'POST',
                    body: syncFormData
                });
                
                if (!syncResponse.ok) {
                    const errorData = await syncResponse.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server error: ${syncResponse.status}`);
                }
                
                const syncData = await syncResponse.json();
                return syncData;
            };
            
            try {
                // Try SSE endpoint first
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    console.warn('SSE endpoint failed, trying sync endpoint...');
                    const finalData = await trySyncEndpoint();
                    resultArea.innerHTML = renderSkillAnalyzerResults(finalData);
                    return;
                }
                
                // Check if response is actually a stream
                if (!response.body) {
                    console.warn('No response body, trying sync endpoint...');
                    const finalData = await trySyncEndpoint();
                    resultArea.innerHTML = renderSkillAnalyzerResults(finalData);
                    return;
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;
                let streamError = null;
                let timeoutId = null;
                
                // Set a timeout for the stream (30 seconds)
                const streamTimeout = new Promise((_, reject) => {
                    timeoutId = setTimeout(() => {
                        reject(new Error('Stream timeout'));
                    }, 30000);
                });
                
                try {
                    const readStream = async () => {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonStr = line.slice(6).trim();
                                        if (!jsonStr) continue;
                                        
                                        const data = JSON.parse(jsonStr);
                                        
                                        if (data.type === 'progress') {
                                            if (progressText) {
                                                let message = data.message;
                                                message = message.replace(/^Step \d+:\s*/i, '');
                                                progressText.textContent = message;
                                            }
                                        } else if (data.type === 'complete') {
                                            finalData = data.data;
                                        } else if (data.type === 'error') {
                                            streamError = new Error(data.message);
                                        }
                                    } catch (e) {
                                        console.error('Error parsing SSE data:', e, 'Line:', line);
                                    }
                                }
                            }
                        }
                    };
                    
                    await Promise.race([readStream(), streamTimeout]);
                    
                    if (timeoutId) clearTimeout(timeoutId);
                    
                    if (streamError) {
                        throw streamError;
                    }
                    
                    if (finalData) {
                        resultArea.innerHTML = renderSkillAnalyzerResults(finalData);
                    } else {
                        // No data from stream, try sync endpoint
                        console.warn('No data from SSE stream, trying sync endpoint...');
                        const syncData = await trySyncEndpoint();
                        resultArea.innerHTML = renderSkillAnalyzerResults(syncData);
                    }
                } catch (streamErr) {
                    if (timeoutId) clearTimeout(timeoutId);
                    console.warn('Stream error:', streamErr, '- trying sync endpoint...');
                    try {
                        const syncData = await trySyncEndpoint();
                        resultArea.innerHTML = renderSkillAnalyzerResults(syncData);
                    } catch (syncErr) {
                        throw syncErr;
                    }
                }
            } catch (error) {
                console.error('Request error:', error);
                resultArea.innerHTML = '<div class="alert alert-error">‚ùå Error: ' + escapeHtml(error.message) + '</div>';
            } finally {
                submitBtn.disabled = false;
            }
        });
        
        // Cover Letter form handler with automatic fallback to sync endpoint
        document.getElementById('coverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const resumeFile = document.getElementById('coverResume').files[0];
            const jobText = document.getElementById('coverJobText').value;
            const templateFile = document.getElementById('coverTemplate').files[0];
            
            if (!resumeFile || !jobText) {
                alert('Please upload a resume and provide a job description.');
                return;
            }
            
            formData.append('resume', resumeFile);
            formData.append('job_text', jobText);
            if (templateFile) {
                formData.append('template', templateFile);
            }
            
            const submitBtn = document.querySelector('#coverForm button[type="submit"]');
            const coverView = document.getElementById('coverLetterView');
            
            submitBtn.disabled = true;
            
            // Clear previous cover letter text
            currentCoverLetterText = '';
            
            // Initialize simple progress display - single line with spinner (minimal spacing)
            coverView.innerHTML = '<div style="padding: 0; display: flex; align-items: center; gap: 12px;"><div class="spinner" style="border: 2px solid var(--border-color); border-top: 2px solid var(--accent-primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;"></div><span id="coverProgressText" style="color: var(--text-secondary); font-size: 14px;">Processing...</span></div>';
            const progressText = document.getElementById('coverProgressText');
            
            // Helper function to render cover letter
            const renderCoverLetter = (finalData) => {
                const letterText = finalData.cover_letter || '';
                const lines = letterText.split('\n');
                
                // Extract first line (name) and rest of the content
                const firstName = lines[0]?.trim() || '';
                const restOfContent = lines.slice(1).join('\n');
                
                // Split remaining content into paragraphs
                const paragraphs = restOfContent.split(/\n{2,}/).map(p => {
                    const para = p.replace(/\n/g, '<br>');
                    return `<p>${para}</p>`;
                }).join('');
                
                // Create header with name and copy button
                const headerHtml = `
                    <div class="cover-letter-header">
                        <div class="cover-letter-name">${escapeHtml(firstName)}</div>
                        <button class="copy-button" onclick="copyCoverLetter()" title="Copy cover letter">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                `;
                
                coverView.innerHTML = headerHtml + paragraphs;
                currentCoverLetterText = letterText;
            };
            
            // Helper function to try sync endpoint as fallback
            const trySyncEndpoint = async () => {
                if (progressText) {
                    progressText.textContent = 'Processing (using fallback method)...';
                }
                // Recreate FormData since it can only be read once
                const syncFormData = new FormData();
                syncFormData.append('resume', resumeFile);
                syncFormData.append('job_text', jobText);
                if (templateFile) {
                    syncFormData.append('template', templateFile);
                }
                
                const syncResponse = await fetch('/cover-letter-sync', {
                    method: 'POST',
                    body: syncFormData
                });
                
                if (!syncResponse.ok) {
                    const errorData = await syncResponse.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server error: ${syncResponse.status}`);
                }
                
                const syncData = await syncResponse.json();
                return syncData;
            };
            
            try {
                // Try SSE endpoint first
                const response = await fetch('/cover-letter', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    console.warn('SSE endpoint failed, trying sync endpoint...');
                    const finalData = await trySyncEndpoint();
                    renderCoverLetter(finalData);
                    return;
                }
                
                // Check if response is actually a stream
                if (!response.body) {
                    console.warn('No response body, trying sync endpoint...');
                    const finalData = await trySyncEndpoint();
                    renderCoverLetter(finalData);
                    return;
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finalData = null;
                let streamError = null;
                let timeoutId = null;
                
                // Set a timeout for the stream (30 seconds)
                const streamTimeout = new Promise((_, reject) => {
                    timeoutId = setTimeout(() => {
                        reject(new Error('Stream timeout'));
                    }, 30000);
                });
                
                try {
                    const readStream = async () => {
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.trim() === '') continue;
                                
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonStr = line.slice(6).trim();
                                        if (!jsonStr) continue;
                                        
                                        const data = JSON.parse(jsonStr);
                                        
                                        if (data.type === 'progress') {
                                            if (progressText) {
                                                let message = data.message;
                                                message = message.replace(/^Step \d+:\s*/i, '');
                                                progressText.textContent = message;
                                            }
                                        } else if (data.type === 'complete') {
                                            finalData = data.data;
                                        } else if (data.type === 'error') {
                                            streamError = new Error(data.message);
                                        }
                                    } catch (e) {
                                        console.error('Error parsing SSE data:', e, 'Line:', line);
                                    }
                                }
                            }
                        }
                    };
                    
                    await Promise.race([readStream(), streamTimeout]);
                    
                    if (timeoutId) clearTimeout(timeoutId);
                    
                    if (streamError) {
                        throw streamError;
                    }
                    
                    if (finalData) {
                        renderCoverLetter(finalData);
                    } else {
                        // No data from stream, try sync endpoint
                        console.warn('No data from SSE stream, trying sync endpoint...');
                        const syncData = await trySyncEndpoint();
                        renderCoverLetter(syncData);
                    }
                } catch (streamErr) {
                    if (timeoutId) clearTimeout(timeoutId);
                    console.warn('Stream error:', streamErr, '- trying sync endpoint...');
                    try {
                        const syncData = await trySyncEndpoint();
                        renderCoverLetter(syncData);
                    } catch (syncErr) {
                        throw syncErr;
                    }
                }
            } catch (error) {
                console.error('Request error:', error);
                coverView.innerHTML = '<div class="alert alert-error">‚ùå Error: ' + escapeHtml(error.message) + '</div>';
            } finally {
                submitBtn.disabled = false;
            }
        });
        
        // Store cover letter text globally for copying
        let currentCoverLetterText = '';
        
        // Copy cover letter function
        function copyCoverLetter() {
            if (!currentCoverLetterText) {
                return;
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(currentCoverLetterText).then(() => {
                // Show "copied" message
                showCopyMessage();
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = currentCoverLetterText;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopyMessage();
                } catch (e) {
                    console.error('Fallback copy failed:', e);
                }
                document.body.removeChild(textArea);
            });
        }
        
        function showCopyMessage() {
            // Remove existing message if any
            const existingMsg = document.querySelector('.copy-message');
            if (existingMsg) {
                existingMsg.remove();
            }
            
            // Create and show message
            const message = document.createElement('div');
            message.className = 'copy-message';
            message.textContent = 'Copied!';
            document.body.appendChild(message);
            
            // Trigger animation
            setTimeout(() => {
                message.classList.add('show');
            }, 10);
            
            // Hide after 2 seconds
            setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => {
                    message.remove();
                }, 300);
            }, 2000);
        }
    </script>
</body>
</html>

